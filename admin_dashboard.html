<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AgroConnect</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <nav>
            <a href="#" class="logo" onclick="event.preventDefault()">ðŸŒ¾ AgroConnect</a>
            <ul class="nav-links">
                <li><a href="admin_dashboard.html" class="active">Admin Dashboard</a></li>
                <li><a href="#" onclick="return logout(event)" class="logout-btn">Logout</a></li>
            </ul>
        </nav>
    </header>

    <div class="container dashboard">
        <aside class="sidebar">
            <h3>Admin Menu</h3>
            <ul>
                <li><a href="#dashboard" class="nav-item active" data-section="dashboard">Dashboard</a></li>
                <li><a href="#farmers" class="nav-item" data-section="farmers">Manage Farmers</a></li>
                <li><a href="#crops" class="nav-item" data-section="crops">Manage Crop Posts</a></li>
                <li><a href="#blocked" class="nav-item" data-section="blocked">Blocked Users</a></li>
                <li><a href="#deleted" class="nav-item" data-section="deleted">Recently Deleted Posts</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section">
                <div class="welcome-banner">
                    <h2>Admin Dashboard</h2>
                    <p>Manage farmers, crops, and moderate content</p>
                </div>

                <h3>Overview</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                    <div class="card" style="text-align: center;">
                        <h4 style="color: #0066CC;">Total Farmers</h4>
                        <p style="font-size: 2.5rem; font-weight: 700; color: #333;" id="total-farmers">0</p>
                    </div>
                    <div class="card" style="text-align: center;">
                        <h4 style="color: #059669;">Total Crop Posts</h4>
                        <p style="font-size: 2.5rem; font-weight: 700; color: #333;" id="total-crops">0</p>
                    </div>
                    <div class="card" style="text-align: center;">
                        <h4 style="color: #DC2626;">Blocked Farmers</h4>
                        <p style="font-size: 2.5rem; font-weight: 700; color: #333;" id="blocked-farmers">0</p>
                    </div>
                </div>
            </section>

            <!-- Manage Farmers Section -->
            <section id="farmers" class="content-section hidden">
                <h3>Manage Farmers</h3>
                
                <div class="form-group" style="max-width: 400px; margin-bottom: 1.5rem;">
                    <input type="text" id="farmerSearchInput" placeholder="Search by name, email, or region..." onkeyup="filterFarmers()">
                </div>
                
                <div id="farmers-container" class="table-container"></div>
            </section>

            <!-- Manage Crops Section -->
            <section id="crops" class="content-section hidden">
                <h3>Manage Crop Posts</h3>
                
                <div class="form-group" style="max-width: 400px; margin-bottom: 1.5rem;">
                    <input type="text" id="cropSearchInput" placeholder="Search by crop name, farmer, or region..." onkeyup="filterCrops()">
                </div>
                
                <div id="crops-container" class="table-container"></div>
            </section>

            <!-- Blocked Users Section -->
            <section id="blocked" class="content-section hidden">
                <h3>Blocked Users</h3>
                
                <div id="blocked-container" class="table-container"></div>
            </section>

            <!-- Recently Deleted Posts Section -->
            <section id="deleted" class="content-section hidden">
                <h3>Recently Deleted Posts</h3>
                <p style="color: #666; margin-bottom: 1rem;">Posts deleted in the last 30 days</p>
                
                <div id="deleted-container" class="table-container"></div>
            </section>
        </main>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2024 AgroConnect - Empowering Farmers. All rights reserved.</p>
        </div>
    </footer>

    <script src="js/validation.js"></script>
    <script src="js/script.js"></script>
    <script>
        let allFarmers = [];
        let allCrops = [];
        let deletedCrops = [];
        let filteredFarmers = [];
        let filteredCrops = [];

        // Initialize admin dashboard
        async function initAdminDashboard() {
            await checkAdminSession();
            loadFarmers();
            loadCrops();
            loadDeletedCrops();
        }

        // Load all farmers
        async function loadFarmers() {
            try {
                const response = await fetch('php/admin_get_farmers.php');
                const data = await response.json();
                
                if (data.success) {
                    allFarmers = data.farmers;
                    displayFarmers(data.farmers);
                    displayBlockedFarmers(data.farmers.filter(f => f.is_blocked == 1 || f.is_blocked === '1'));
                    updateDashboardStats();
                }
            } catch (error) {
                console.error('Load farmers error:', error);
            }
        }

        // Display farmers
        function displayFarmers(farmers) {
            const container = document.getElementById('farmers-container');
            
            if (farmers.length === 0) {
                container.innerHTML = '<p class="text-center">No farmers registered yet.</p>';
                return;
            }
            
            const activeFarmers = farmers.filter(f => f.is_blocked != 1 && f.is_blocked !== '1');
            filteredFarmers = activeFarmers; // Store for search
            
            if (activeFarmers.length === 0) {
                container.innerHTML = '<p class="text-center">No active farmers found.</p>';
                return;
            }
            
            container.innerHTML = `
                <table id="farmersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Region</th>
                            <th>Soil Type</th>
                            <th>Area</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${activeFarmers.map(farmer => `
                            <tr>
                                <td>${farmer.name}</td>
                                <td>${farmer.email}</td>
                                <td>${farmer.region}</td>
                                <td>${farmer.soil_type}</td>
                                <td>${farmer.area} acres</td>
                                <td><span class="badge badge-success">Active</span></td>
                                <td class="actions">
                                    <button class="btn btn-small btn-danger" onclick="blockFarmer(${farmer.farmer_id})">Block</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Filter farmers based on search input
        function filterFarmers() {
            const searchInput = document.getElementById('farmerSearchInput').value.toLowerCase();
            const table = document.getElementById('farmersTable');
            
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                
                if (text.includes(searchInput)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        // Display blocked farmers
        function displayBlockedFarmers(farmers) {
            const container = document.getElementById('blocked-container');
            
            if (farmers.length === 0) {
                container.innerHTML = '<p class="text-center">No blocked farmers.</p>';
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Region</th>
                            <th>Blocked On</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${farmers.map(farmer => `
                            <tr>
                                <td>${farmer.name}</td>
                                <td>${farmer.email}</td>
                                <td>${farmer.region}</td>
                                <td>${formatDate(farmer.created_at)}</td>
                                <td class="actions">
                                    <button class="btn btn-small btn-success" onclick="unblockFarmer(${farmer.farmer_id})">Unblock</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Load all crops
        async function loadCrops() {
            try {
                const response = await fetch('php/admin_get_crops.php');
                const data = await response.json();
                
                if (data.success) {
                    allCrops = data.crops;
                    displayCrops(data.crops);
                    updateDashboardStats();
                }
            } catch (error) {
                console.error('Load crops error:', error);
            }
        }

        // Display crops
        function displayCrops(crops) {
            const container = document.getElementById('crops-container');
            
            if (crops.length === 0) {
                container.innerHTML = '<p class="text-center">No crop posts yet.</p>';
                return;
            }
            
            filteredCrops = crops; // Store for search
            
            container.innerHTML = `
                <table id="cropsTable">
                    <thead>
                        <tr>
                            <th>Crop Name</th>
                            <th>Farmer</th>
                            <th>Region</th>
                            <th>Investment</th>
                            <th>Turnover</th>
                            <th>Posted On</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${crops.map(crop => `
                            <tr>
                                <td>${crop.crop_name}</td>
                                <td>${crop.farmer_name}<br><small style="color: #666;">${crop.farmer_email}</small></td>
                                <td>${crop.region}</td>
                                <td>${formatCurrency(crop.investment)}</td>
                                <td>${formatCurrency(crop.turnover)}</td>
                                <td>${formatDate(crop.created_at)}</td>
                                <td class="actions">
                                    <button class="btn btn-small btn-danger" onclick="adminDeleteCrop(${crop.crop_id})">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Filter crops based on search input
        function filterCrops() {
            const searchInput = document.getElementById('cropSearchInput').value.toLowerCase();
            const table = document.getElementById('cropsTable');
            
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                
                if (text.includes(searchInput)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        // Load deleted crops
        async function loadDeletedCrops() {
            try {
                const response = await fetch('php/admin_get_deleted_crops.php');
                const data = await response.json();
                
                if (data.success) {
                    deletedCrops = data.crops;
                    displayDeletedCrops(data.crops);
                }
            } catch (error) {
                console.error('Load deleted crops error:', error);
            }
        }

        // Display deleted crops
        function displayDeletedCrops(crops) {
            const container = document.getElementById('deleted-container');
            
            if (crops.length === 0) {
                container.innerHTML = '<p class="text-center">No recently deleted posts.</p>';
                return;
            }
            
            container.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Crop Name</th>
                            <th>Farmer</th>
                            <th>Region</th>
                            <th>Investment</th>
                            <th>Turnover</th>
                            <th>Deleted</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${crops.map(crop => `
                            <tr style="opacity: 0.7;">
                                <td>${crop.crop_name}</td>
                                <td>${crop.farmer_name}<br><small style="color: #666;">${crop.farmer_email}</small></td>
                                <td>${crop.region}</td>
                                <td>${formatCurrency(crop.investment)}</td>
                                <td>${formatCurrency(crop.turnover)}</td>
                                <td><span class="time-badge" style="background: #FEE2E2; color: #DC2626;">${timeAgo(crop.deleted_at)}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Update dashboard stats
        function updateDashboardStats() {
            document.getElementById('total-farmers').textContent = allFarmers.length;
            document.getElementById('total-crops').textContent = allCrops.length;
            document.getElementById('blocked-farmers').textContent = allFarmers.filter(f => f.is_blocked == 1 || f.is_blocked === '1').length;
        }

        // Block farmer
        async function blockFarmer(farmerId) {
            console.log('Block farmer called with ID:', farmerId);
            
            if (!confirm('Are you sure you want to block this farmer?')) {
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('farmer_id', farmerId);
                
                const response = await fetch('php/admin_block_farmer.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });
                
                console.log('Block response status:', response.status);
                
                const data = await response.json();
                console.log('Block response data:', data);
                
                if (data.success) {
                    if (typeof showAlert === 'function') {
                        showAlert(data.message, 'success');
                    } else {
                        alert(data.message);
                    }
                    loadFarmers();
                } else {
                    if (typeof showAlert === 'function') {
                        showAlert(data.message, 'error');
                    } else {
                        alert(data.message);
                    }
                }
            } catch (error) {
                console.error('Block farmer error:', error);
                if (typeof showAlert === 'function') {
                    showAlert('An error occurred while blocking the farmer.', 'error');
                } else {
                    alert('An error occurred while blocking the farmer.');
                }
            }
        }

        // Unblock farmer
        async function unblockFarmer(farmerId) {
            console.log('Unblock farmer called with ID:', farmerId);
            
            if (!confirm('Are you sure you want to unblock this farmer?')) {
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('farmer_id', farmerId);
                
                const response = await fetch('php/admin_unblock_farmer.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });
                
                console.log('Unblock response status:', response.status);
                
                const data = await response.json();
                console.log('Unblock response data:', data);
                
                if (data.success) {
                    if (typeof showAlert === 'function') {
                        showAlert(data.message, 'success');
                    } else {
                        alert(data.message);
                    }
                    loadFarmers();
                } else {
                    if (typeof showAlert === 'function') {
                        showAlert(data.message, 'error');
                    } else {
                        alert(data.message);
                    }
                }
            } catch (error) {
                console.error('Unblock farmer error:', error);
                if (typeof showAlert === 'function') {
                    showAlert('An error occurred while unblocking the farmer.', 'error');
                } else {
                    alert('An error occurred while unblocking the farmer.');
                }
            }
        }

        // Delete crop
        async function adminDeleteCrop(cropId) {
            console.log('Delete crop called with ID:', cropId);
            
            if (!confirm('Are you sure you want to delete this crop post?')) {
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('crop_id', cropId);
                
                const response = await fetch('php/admin_delete_crop.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });
                
                console.log('Delete crop response status:', response.status);
                
                const data = await response.json();
                console.log('Delete crop response data:', data);
                
                if (data.success) {
                    if (typeof showAlert === 'function') {
                        showAlert(data.message, 'success');
                    } else {
                        alert(data.message);
                    }
                    loadCrops();
                } else {
                    if (typeof showAlert === 'function') {
                        showAlert(data.message, 'error');
                    } else {
                        alert(data.message);
                    }
                }
            } catch (error) {
                console.error('Delete crop error:', error);
                if (typeof showAlert === 'function') {
                    showAlert('An error occurred while deleting the crop.', 'error');
                } else {
                    alert('An error occurred while deleting the crop.');
                }
            }
        }

        // Navigation between sections
        document.querySelectorAll('.nav-item').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Update active state
                document.querySelectorAll('.nav-item').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                
                // Show selected section
                const section = link.dataset.section;
                document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
                document.getElementById(section).classList.remove('hidden');
            });
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', initAdminDashboard);
    </script>
</body>
</html>

